<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion Scanneurs</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Sortie / Retour Scanneurs</h1>

  <label>Badge ID : <input type="text" id="badgeId" /></label><br />
  <label>Scanner ID : <input type="text" id="scannerId" /></label><br />

  <button onclick="sortie()">Sortie</button>
  <button onclick="retour()">Retour</button>

  <script>
    const supabaseUrl = 'https://jwmrapjeofqigzqvvdep.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3bXJhcGplb2ZxaWd6cXZ2ZGVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxOTc3NzUsImV4cCI6MjA2NDc3Mzc3NX0.RfG59P69T9F2MtwEf6kOQ7cdfTUCJ3hHx1YCGLJpeGI'

    const supabase = supabase.createClient(supabaseUrl, supabaseKey)

    async function sortie() {
      const badgeId = document.getElementById('badgeId').value.trim()
      const scannerId = document.getElementById('scannerId').value.trim()
      if (!badgeId || !scannerId) {
        alert('Merci de remplir Badge ID et Scanner ID')
        return
      }

      // Vérifier si scanner est disponible
      const { data: scanner, error: errScan } = await supabase
        .from('Scanners')
        .select('Status')
        .eq('ScannerID', scannerId)
        .single()

      if (errScan) {
        alert('Erreur: ' + errScan.message)
        return
      }
      if (!scanner || scanner.Status !== 'disponible') {
        alert('Scanner non disponible.')
        return
      }

      // Ajouter emprunt
      const { error: errEmprunt } = await supabase.from('Emprunts').insert([{ BadgeID: badgeId, ScannerID: scannerId }])
      if (errEmprunt) {
        alert('Erreur ajout emprunt: ' + errEmprunt.message)
        return
      }

      // Mettre à jour statut scanner
      const { error: errUpdate } = await supabase
        .from('Scanners')
        .update({ Status: 'emprunté' })
        .eq('ScannerID', scannerId)

      if (errUpdate) {
        alert('Erreur mise à jour scanner: ' + errUpdate.message)
        return
      }

      alert('Sortie enregistrée avec succès !')
    }

    async function retour() {
      const badgeId = document.getElementById('badgeId').value.trim()
      const scannerId = document.getElementById('scannerId').value.trim()
      if (!badgeId || !scannerId) {
        alert('Merci de remplir Badge ID et Scanner ID')
        return
      }

      // Vérifier si emprunt existe
      const { data: emprunt, error: errEmprunt } = await supabase
        .from('Emprunts')
        .select('*')
        .eq('BadgeID', badgeId)
        .eq('ScannerID', scannerId)
        .single()

      if (errEmprunt || !emprunt) {
        alert('Aucun emprunt trouvé pour ce badge et scanner.')
        return
      }

      // Supprimer emprunt
      const { error: errDelete } = await supabase
        .from('Emprunts')
        .delete()
        .eq('BadgeID', badgeId)
        .eq('ScannerID', scannerId)

      if (errDelete) {
        alert('Erreur suppression emprunt: ' + errDelete.message)
        return
      }

      // Mettre à jour statut scanner
      const { error: errUpdate } = await supabase
        .from('Scanners')
        .update({ Status: 'disponible' })
        .eq('ScannerID', scannerId)

      if (errUpdate) {
        alert('Erreur mise à jour scanner: ' + errUpdate.message)
        return
      }

      // Ajouter dans historique
      const { error: errHist } = await supabase.from('Historique').insert([{
        BadgeID_Sortie: badgeId,
        ScannerID: scannerId,
        DateRetour: new Date().toISOString()
      }])

      if (errHist) {
        alert('Erreur ajout historique: ' + errHist.message)
        return
      }

      alert('Retour enregistré avec succès !')
    }
  </script>
</body>
</html>
