<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion Scanneurs - Auto Submit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #eee;
      padding: 20px;
    }
    label, input, select {
      display: block;
      margin: 10px 0;
      font-size: 18px;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>Gestion Scanneurs</h1>

  <form id="scanForm" onsubmit="return false;">
    <label for="badgeId">Badge :</label>
    <input type="text" id="badgeId" placeholder="Scan du badge" autofocus required />

    <label for="scannerId">Scanneur :</label>
    <select id="scannerId" required></select>
  </form>

  <div id="status"></div>

  <h2>Scanneurs Disponibles</h2>
  <ul id="availableList"></ul>

  <h2>Badges en Emprunt</h2>
  <ul id="borrowedList"></ul>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'https://jwmrapjeofqigzqvvdep.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3bXJhcGplb2ZxaWd6cXZ2ZGVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxOTc3NzUsImV4cCI6MjA2NDc3Mzc3NX0.RfG59P69T9F2MtwEf6kOQ7cdfTUCJ3hHx1YCGLJpeGI';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const badgeInput = document.getElementById("badgeId");
    const scannerSelect = document.getElementById("scannerId");
    const availableList = document.getElementById("availableList");
    const borrowedList = document.getElementById("borrowedList");
    const statusDiv = document.getElementById("status");

    badgeInput.addEventListener("input", tryAutoSubmit);
    scannerSelect.addEventListener("change", tryAutoSubmit);

    async function refreshLists() {
      try {
        // Liste scanners disponibles
        const { data: availableScanners, error: availErr } = await supabase
          .from('Scanners')
          .select('ScannerID')
          .eq('Status', 'disponible');

        if (availErr) throw availErr;

        scannerSelect.innerHTML = availableScanners.length
          ? availableScanners.map(s => `<option value="${s.ScannerID}">${s.ScannerID}</option>`).join('')
          : `<option value="">Aucun disponible</option>`;

        availableList.innerHTML = availableScanners.length
          ? availableScanners.map(s => `<li>${s.ScannerID}</li>`).join('')
          : `<li>Aucun scanneur disponible</li>`;

        // Liste emprunts en cours
        const { data: emprunts, error: empErr } = await supabase
          .from('Emprunts')
          .select('BadgeID, ScannerID')
          .is('DateRetour', null);

        if (empErr) throw empErr;

        borrowedList.innerHTML = emprunts.length
          ? emprunts.map(e => `<li>Badge: ${e.BadgeID} - Scanneur: ${e.ScannerID}</li>`).join('')
          : `<li>Aucun badge en emprunt</li>`;

      } catch (err) {
        console.error("Erreur chargement listes:", err);
        setStatus("Erreur chargement des données.", true);
      }
    }

    function setStatus(msg, isError = false) {
      statusDiv.textContent = msg;
      statusDiv.style.color = isError ? "#f55" : "#5f5";
    }

    function tryAutoSubmit() {
      const badgeId = badgeInput.value.trim();
      const scannerId = scannerSelect.value;

      if (badgeId && scannerId) {
        handleSubmit(badgeId, scannerId);
      }
    }

    async function handleSubmit(badgeId, scannerId) {
      setStatus("Envoi en cours...");
      badgeInput.disabled = true;
      scannerSelect.disabled = true;

      try {
        const { data: scannerData, error: scanErr } = await supabase
          .from('Scanners')
          .select('Status')
          .eq('ScannerID', scannerId)
          .single();

        if (scanErr || !scannerData || scannerData.Status !== 'disponible') {
          setStatus("Scanneur non disponible.", true);
          badgeInput.disabled = false;
          scannerSelect.disabled = false;
          return;
        }

        const { error: insertErr } = await supabase.from('Emprunts').insert({
          BadgeID: badgeId,
          ScannerID: scannerId,
          DateSortie: new Date().toISOString(),
          DateRetour: null
        });

        if (insertErr) throw insertErr;

        const { error: updateErr } = await supabase
          .from('Scanners')
          .update({ Status: 'emprunté' })
          .eq('ScannerID', scannerId);

        if (updateErr) throw updateErr;

        setStatus("Prêt enregistré avec succès.");
        badgeInput.value = "";
        badgeInput.focus();
        scannerSelect.selectedIndex = 0;

      } catch (error) {
        console.error(error);
        setStatus("Erreur lors de l'enregistrement.", true);
      }

      badgeInput.disabled = false;
      scannerSelect.disabled = false;
      refreshLists();
    }

    refreshLists();
  </script>

</body>
</html>
