<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion Scanneurs - Astro 2090</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ton style existant, inchangé */
  </style>
</head>
<body>
  <!-- INTRO SCREEN -->
  <div id="introScreen">
    <div class="intro-content">
      <h1>Bienvenue dans le système</h1>
      <p>Astro D'Ara 2090</p>
      <button onclick="hideIntro()">Entrer</button>
    </div>
  </div>

  <h1>Gestion Scanneurs</h1>
  <div class="tabs">
    <button class="tab-button active" onclick="setMode('Sortie')">Sortie</button>
    <button class="tab-button" onclick="setMode('Retour')">Retour</button>
  </div>

  <div class="main-container">
    <div class="list-box" id="borrowedBox">
      <h3>Badges en emprunt</h3><ul id="borrowedList"><li>Chargement...</li></ul>
    </div>

    <form class="scanner-form" onsubmit="return false;" autocomplete="off" spellcheck="false">
      <input type="text" id="badgeId" placeholder="Scanner Votre badge" autofocus />
      <input type="text" id="scannerId" placeholder="Scanner le scanneur" />
      <div class="status" id="statusMessage"></div>
    </form>

    <div class="list-box" id="availableBox">
      <h3>Scanneurs disponibles</h3><ul id="availableList"><li>Chargement...</li></ul>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const SUPABASE_URL = 'https://jwmrapjeofqigzqvvdep.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhb...'; // ta clé
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const badgeInput = document.getElementById("badgeId");
  const scannerInput = document.getElementById("scannerId");
  const availableList = document.getElementById("availableList");
  const borrowedList = document.getElementById("borrowedList");
  const statusDiv = document.getElementById("statusMessage");
  let mode = "Sortie";

  window.onload = () => {
    hideIntro(); setMode("Sortie"); refreshLists();
  };

  function hideIntro() {
    document.getElementById('introScreen').style.display = 'none';
  }

  function setMode(m) {
    mode = m;
    document.querySelectorAll('.tab-button').forEach(b => b.classList.toggle('active', b.textContent === m));
    badgeInput.value = ''; scannerInput.value = ''; setStatus("");
    badgeInput.focus();
  }

  badgeInput.addEventListener("input", trySubmit);
  scannerInput.addEventListener("input", trySubmit);

  function setStatus(msg, err=false) {
    statusDiv.textContent = msg;
    statusDiv.classList.toggle('error', err);
  }

  async function refreshLists() {
    // Scanneurs dispo
    let { data: av, error: e1 } = await supabase.from('Scanners').select('ScannerID').eq('Status','disponible');
    availableList.innerHTML = e1 ? '<li>Erreur</li>' :
      av.length ? av.map(s => `<li>${s.ScannerID}</li>`).join('') : '<li>Aucun scanneur disponible</li>';
    // Emprunts en cours
    let { data: em, error: e2 } = await supabase.from('Emprunts').select('BadgeID,ScannerID').is('DateRetour', null);
    borrowedList.innerHTML = e2 ? '<li>Erreur</li>' :
      em.length ? em.map(x => `<li>Badge ${x.BadgeID} → Scanneur ${x.ScannerID}</li>`).join('') : '<li>Aucun badge en emprunt</li>';
  }

  function trySubmit() {
    if (badgeInput.value.trim() && scannerInput.value.trim()) {
      handleSubmit();
    }
  }

  async function handleSubmit() {
    const b = badgeInput.value.trim(), s = scannerInput.value.trim();
    setStatus("Envoi...",false);
    badgeInput.disabled = true; scannerInput.disabled = true;

    const { data: sd, error: e1 } = await supabase.from('Scanners').select('Status').eq('ScannerID', s).single();
    if (e1 || !sd || sd.Status !== 'disponible') {
      setStatus("Scanneur non dispo", true);
      badgeInput.disabled= scannerInput.disabled=false; return;
    }

    let { error: e2 } = await supabase.from('Emprunts').insert({ BadgeID:b, ScannerID:s, DateSortie: new Date().toISOString(), DateRetour:null });
    let { error: e3 } = await supabase.from('Scanners').update({ Status:'emprunté' }).eq('ScannerID', s);
    if (e2||e3) {
      setStatus("Erreur !", true);
    } else {
      setStatus("Enregistré");
      badgeInput.value=''; scannerInput.value='';
    }

    badgeInput.disabled= scannerInput.disabled=false;
    badgeInput.focus();
    await refreshLists();
  }
</script>
</body>
</html>
