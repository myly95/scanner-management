<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion Scanneurs - Astro 2090</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap');

    body {
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background: black;
      color: #0ff;
    }

    #introScreen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at center, #111, #000);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      transition: opacity 1s ease;
      z-index: 1000;
    }

    #app {
      padding: 2em;
    }

    input, button {
      font-family: 'Orbitron', sans-serif;
      font-size: 1em;
      padding: 0.5em;
      background: #111;
      color: #0ff;
      border: 1px solid #0ff;
      margin: 0.2em 0;
    }

    #availableList, #borrowedList {
      list-style: none;
      padding-left: 0;
    }

    h2 {
      margin-top: 2em;
      color: #0ff;
    }

    .mode-toggle {
      margin-bottom: 1em;
    }
  </style>
</head>
<body onload="setTimeout(hideIntro, 2000)">
  <div id="introScreen">ASTRO 2090 - Initialisation...</div>
  <div id="app">
    <button id="modeBtn" class="mode-toggle">Sortie</button>
    <form id="scanForm">
      <label>Badge ID:</label><br />
      <input type="text" id="badgeId" required /><br />
      <label>Scanner ID:</label><br />
      <input type="text" id="scannerId" required /><br />
      <button type="submit">Valider</button>
    </form>
    <div id="status"></div>

    <h2>üì¶ Scanneurs Disponibles</h2>
    <ul id="availableList"></ul>

    <h2>üßë‚Äçüíª Badges en Emprunt</h2>
    <ul id="borrowedList"></ul>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://jwmrapjeofqigzqvvdep.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3bXJhcGplb2ZxaWd6cXZ2ZGVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxOTc3NzUsImV4cCI6MjA2NDc3Mzc3NX0.RfG59P69T9F2MtwEf6kOQ7cdfTUCJ3hHx1YCGLJpeGI';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById("scanForm");
    const modeBtn = document.getElementById("modeBtn");
    const statusDiv = document.getElementById("status");
    const availableList = document.getElementById("availableList");
    const borrowedList = document.getElementById("borrowedList");

    let mode = "Sortie";

    modeBtn.addEventListener("click", () => {
      mode = mode === "Sortie" ? "Retour" : "Sortie";
      modeBtn.textContent = mode;
      setStatus("");
      resetForm();
      refreshLists();
    });

    form.addEventListener("submit", handleSubmit);

    function setStatus(msg, isError = false) {
      statusDiv.textContent = msg;
      statusDiv.style.color = isError ? "#FF5555" : "#55FF55";
    }

    function resetForm() {
      form.reset();
      document.getElementById("badgeId").focus();
    }

    async function refreshLists() {
      try {
        const { data: availableScanners, error: availErr } = await supabase
          .from('Scanners')
          .select('ScannerID')
          .eq('Status', 'disponible');

        if (availErr) throw availErr;

        availableList.innerHTML = availableScanners.length
          ? availableScanners.map(s => `<li>${s.ScannerID}</li>`).join('')
          : "<li>Aucun scanneur disponible</li>";

        const { data: emprunts, error: empruntErr } = await supabase
          .from('Emprunts')
          .select('BadgeID, ScannerID')
          .is('DateRetour', null);

        if (empruntErr) throw empruntErr;

        borrowedList.innerHTML = emprunts.length
          ? emprunts.map(e => `<li>Badge: ${e.BadgeID} - Scanneur: ${e.ScannerID}</li>`).join('')
          : "<li>Aucun badge en emprunt</li>";
      } catch (err) {
        console.error("Erreur chargement listes:", err);
        setStatus("Erreur lors du chargement des listes.", true);
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();

      const badgeId = document.getElementById("badgeId").value.trim();
      const scannerId = document.getElementById("scannerId").value.trim();

      if (!badgeId || !scannerId) {
        setStatus("Veuillez scanner le badge et le scanneur.", true);
        return;
      }

      setStatus("Envoi en cours...");
      form.querySelector("button").disabled = true;

      try {
        if (mode === "Sortie") {
          const { data: scannerData, error: scanErr } = await supabase
            .from('Scanners')
            .select('Status')
            .eq('ScannerID', scannerId)
            .maybeSingle();

          if (scanErr) throw scanErr;

          if (!scannerData) {
            setStatus("Scanneur introuvable dans la base.", true);
            return;
          }

          if (scannerData.Status !== 'disponible') {
            setStatus("Scanneur non disponible.", true);
            return;
          }

          const { error: insertErr } = await supabase.from('Emprunts').insert({
            BadgeID: badgeId,
            ScannerID: scannerId,
            DateSortie: new Date().toISOString(),
            DateRetour: null
          });

          if (insertErr) throw insertErr;

          const { error: updateErr } = await supabase
            .from('Scanners')
            .update({ Status: 'emprunt√©' })
            .eq('ScannerID', scannerId);

          if (updateErr) throw updateErr;

          setStatus("Pr√™t enregistr√© avec succ√®s.");
        } else {
          const { data: empruntData, error: empruntErr } = await supabase
            .from('Emprunts')
            .select('*')
            .eq('BadgeID', badgeId)
            .eq('ScannerID', scannerId)
            .is('DateRetour', null)
            .maybeSingle();

          if (empruntErr) throw empruntErr;

          if (!empruntData) {
            setStatus("Emprunt introuvable pour ce badge et ce scanneur.", true);
            return;
          }

          const { error: retourErr } = await supabase
            .from('Emprunts')
            .update({ DateRetour: new Date().toISOString() })
            .eq('BadgeID', badgeId)
            .eq('ScannerID', scannerId)
            .is('DateRetour', null);

          if (retourErr) throw retourErr;

          const { error: updateScanErr } = await supabase
            .from('Scanners')
            .update({ Status: 'disponible' })
            .eq('ScannerID', scannerId);

          if (updateScanErr) throw updateScanErr;

          setStatus("Retour enregistr√© avec succ√®s.");
        }

        resetForm();
        refreshLists();
      } catch (error) {
        console.error(error);
        setStatus("Erreur lors de l'enregistrement.", true);
      }

      form.querySelector("button").disabled = false;
    }

    function hideIntro() {
      const introScreen = document.getElementById('introScreen');
      introScreen.style.opacity = '0';
      setTimeout(() => {
        introScreen.style.display = 'none';
      }, 1000);
    }

    refreshLists();
  </script>
</body>
</html>

